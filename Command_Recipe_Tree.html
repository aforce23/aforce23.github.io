<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KHBBS Recipe Tree</title>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            /* Color Palette (Shared with Meld Calculator) */
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --slate-950: #020617;

            /* Accents */
            --blue-100: #dbeafe;
            --blue-400: #60a5fa;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;

            --orange-400: #fb923c;
            --purple-400: #c084fc;
            --yellow-400: #facc15;
            --green-400: #4ade80;

            /* Category Colors (Soft Backgrounds) */
            --bg-blue-soft: rgba(59, 130, 246, 0.1);
            --border-blue-soft: rgba(59, 130, 246, 0.3);
            --bg-orange-soft: rgba(251, 146, 60, 0.1);
            --border-orange-soft: rgba(251, 146, 60, 0.3);
            --bg-purple-soft: rgba(192, 132, 252, 0.1);
            --border-purple-soft: rgba(192, 132, 252, 0.3);
            --bg-yellow-soft: rgba(250, 204, 21, 0.1);
            --border-yellow-soft: rgba(250, 204, 21, 0.3);
            --bg-green-soft: rgba(74, 222, 128, 0.1);
            --border-green-soft: rgba(74, 222, 128, 0.3);

            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --glow-blue: 0 0 15px rgba(59, 130, 246, 0.3);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--slate-900);
            color: var(--slate-100);
            margin: 0;
            min-height: 100vh;
            padding-bottom: 3rem;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .justify-center {
            justify-content: center;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-4 {
            gap: 1rem;
        }

        .w-full {
            width: 100%;
        }

        .relative {
            position: relative;
        }

        .text-center {
            text-align: center;
        }

        /* Text Colors */
        .text-blue-100 {
            color: var(--blue-100);
        }

        .text-blue-400 {
            color: var(--blue-400);
        }

        .text-slate-400 {
            color: var(--slate-400);
        }

        .text-slate-500 {
            color: var(--slate-500);
        }

        /* Header */
        header {
            background-color: var(--slate-950);
            border-bottom: 1px solid var(--slate-800);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .container {
            max-width: 56rem;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .logo-box {
            background-color: var(--blue-600);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        /* Menu Button */
        .menu-btn {
            background-color: var(--slate-800);
            border: 1px solid var(--slate-600);
            color: var(--blue-400);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .menu-btn:hover {
            background-color: var(--blue-600);
            border-color: var(--blue-500);
            color: white;
            box-shadow: var(--glow-blue);
        }

        /* Input Section */
        .search-section {
            padding: 2rem 0;
            max-width: 32rem;
            margin: 0 auto;
        }

        .input-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--blue-400);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            margin-left: 0.25rem;
        }

        .command-input {
            width: 100%;
            background-color: var(--slate-800);
            border: 2px solid var(--slate-700);
            border-radius: 0.75rem;
            padding: 1rem 1rem 1rem 3rem;
            font-size: 1.125rem;
            color: var(--slate-100);
            transition: all 0.2s;
            outline: none;
        }

        .command-input:focus {
            border-color: var(--blue-500);
            box-shadow: var(--glow-blue);
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 2.5rem;
            /* adjusted for label */
            color: var(--slate-500);
            pointer-events: none;
        }

        /* Suggestions */
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: var(--slate-800);
            border: 1px solid var(--slate-700);
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            max-height: 15rem;
            overflow-y: auto;
            z-index: 50;
            box-shadow: var(--shadow-xl);
        }

        .suggestion-item {
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            color: var(--slate-300);
            cursor: pointer;
            font-size: 1rem;
        }

        .suggestion-item:hover {
            background-color: rgba(37, 99, 235, 0.2);
            color: var(--blue-100);
        }

        /* Tree Visualization */
        .tree-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            animation: fadeIn 0.5s ease-out;
        }

        .node-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: linear-gradient(to right, var(--slate-800), var(--slate-900));
            border: 1px solid var(--slate-700);
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }

        .node-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .node-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin: 0;
        }

        .node-subtitle {
            font-size: 0.875rem;
            color: var(--slate-400);
            margin: 0;
        }

        /* Recipe Options */
        .recipe-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding-left: 1rem;
            border-left: 2px solid var(--slate-700);
            margin-left: 1.5rem;
        }

        .recipe-card {
            background-color: rgba(30, 41, 59, 0.5);
            border: 1px solid var(--slate-700);
            border-radius: 0.5rem;
            /* overflow: hidden; Removed to allow tooltips to show */
            position: relative;
        }

        .recipe-header {
            padding: 0.75rem;
            background-color: var(--slate-800);
            border-bottom: 1px solid var(--slate-700);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: var(--slate-300);
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .recipe-ingredients {
            padding: 1rem;
            display: grid;
            gap: 1rem;
            /* Ensure content doesn't clip tooltips or floating elements */
        }

        @media (min-width: 640px) {
            .recipe-ingredients {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Recursive Details/Summary Styling */
        details.ingredient-node {
            width: 100%;
            position: relative;
            /* Anchor for floating children */
        }

        details.ingredient-node>summary {
            list-style: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: var(--slate-800);
            border: 1px solid var(--slate-700);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        details.ingredient-node>summary:hover {
            border-color: var(--blue-500);
            background-color: var(--slate-700);
        }

        details.ingredient-node[open]>summary {
            background-color: var(--blue-600);
            border-color: var(--blue-500);
            color: white;
        }

        /* Floating Box Logic for Depth > 0 */
        details.ingredient-node>.ingredient-children {
            display: none;
            /* Default hidden */
            padding: 1rem;
            background-color: var(--slate-900);
            border: 1px solid var(--slate-600);
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);

            /* Floating positioning */
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            z-index: 50;
            min-width: 300px;
            max-width: 90vw;
        }

        /* Show when open */
        details.ingredient-node[open]>.ingredient-children {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        /* Arrow for the floating box */
        details.ingredient-node[open]>.ingredient-children::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 1rem;
            width: 10px;
            height: 10px;
            background-color: var(--slate-900);
            border-top: 1px solid var(--slate-600);
            border-left: 1px solid var(--slate-600);
            transform: rotate(45deg);
        }

        .base-ingredient {
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: var(--slate-800);
            border: 1px dashed var(--slate-600);
            color: var(--slate-400);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        /* Tooltip Styles */
        .type-badge-container {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .type-badge {
            background: var(--slate-700);
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            color: var(--slate-200);
            border: 1px solid var(--slate-600);
            transition: background-color 0.2s;
        }

        .type-badge-container:hover .type-badge {
            background: var(--blue-600);
            border-color: var(--blue-500);
            color: white;
        }

        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--slate-800);
            border: 1px solid var(--slate-600);
            color: var(--slate-200);
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 280px;
            /* Increased width for table */
            text-align: left;
            z-index: 70;
            box-shadow: var(--shadow-xl);
            pointer-events: none;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .type-badge-container:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-title {
            color: var(--blue-400);
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            display: block;
            border-bottom: 1px solid var(--slate-700);
            padding-bottom: 0.25rem;
            text-align: center;
        }

        .tooltip-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .tooltip-table td {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .tooltip-table tr:last-child td {
            border-bottom: none;
        }

        .tooltip-table td:first-child {
            color: var(--slate-400);
        }

        .tooltip-table td:last-child {
            text-align: right;
            color: var(--slate-100);
            font-weight: 500;
        }

        .rare-badge {
            color: var(--yellow-400);
            font-size: 0.75rem;
            border: 1px solid rgba(250, 204, 21, 0.3);
            padding: 0.1rem 0.4rem;
            border-radius: 0.25rem;
            background: rgba(250, 204, 21, 0.1);
        }

        /* Dynamic Colors */
        .text-orange-400 {
            color: var(--orange-400);
        }

        .text-purple-400 {
            color: var(--purple-400);
        }

        .text-yellow-400 {
            color: var(--yellow-400);
        }

        .text-green-400 {
            color: var(--green-400);
        }

        .bg-blue-soft {
            background-color: var(--bg-blue-soft);
            border-color: var(--border-blue-soft);
        }

        .bg-orange-soft {
            background-color: var(--bg-orange-soft);
            border-color: var(--border-orange-soft);
        }

        .bg-purple-soft {
            background-color: var(--bg-purple-soft);
            border-color: var(--border-purple-soft);
        }

        .bg-yellow-soft {
            background-color: var(--bg-yellow-soft);
            border-color: var(--border-yellow-soft);
        }

        .bg-green-soft {
            background-color: var(--bg-green-soft);
            border-color: var(--border-green-soft);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="container flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="logo-box">
                    <i data-lucide="git-branch" class="text-white" style="width: 24px; height: 24px;"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-wide text-blue-100">KHBBS Recipe Tree</h1>
                    <p class="text-xs text-slate-400 uppercase tracking-widest">Reverse Lookup System</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <a href="command_meld.html" class="menu-btn">
                    <i data-lucide="calculator" style="width: 16px; height: 16px;"></i>
                    Meld Calc
                </a>
                <a href="#" onclick="window.location.reload()"
                    class="text-xs text-slate-500 hover:text-white transition-colors">Reset</a>
            </div>
        </div>
    </header>

    <main class="container">

        <!-- Search Section -->
        <div class="search-section">
            <div class="relative">
                <label class="input-label">Target Command</label>
                <input type="text" id="targetInput" placeholder="e.g. Mega Flare" class="command-input"
                    autocomplete="off">
                <div class="input-icon">
                    <i data-lucide="search" style="width: 20px; height: 20px;"></i>
                </div>
                <div id="suggestions" class="suggestions-list hidden"></div>
            </div>
        </div>

        <!-- Tree Output -->
        <div id="treeContainer" class="tree-container">
            <div class="empty-state text-center" style="margin-top: 2rem;">
                <p class="text-slate-500">Select a command above to view its recipe tree.</p>
            </div>
        </div>

    </main>

    <script>
        // --- DATA ---
        const RECIPES = [
            { result: "Blitz", s1: "Slot Edge", s2: "Quick Blitz", type: "O" },
            { result: "Blitz", s1: "Slot Edge", s2: "Stun Edge", type: "K" },
            { result: "Blitz", s1: "Barrier Surge", s2: "Wishing Edge", type: "P" },
            { result: "Meteor Crash", s1: "Blitz", s2: "Quake", type: "N" },
            { result: "Meteor Crash", s1: "Fire Strike", s2: "Brutal Blast", type: "D" },
            { result: "Magic Hour", s1: "Blitz", s2: "Zero Graviga", type: "O" },
            { result: "Magic Hour", s1: "Barrier Surge", s2: "Aeroga", type: "N" },
            { result: "Fire Dash", s1: "Sliding Dash", s2: "Fire", type: "D" },
            { result: "Fire Dash", s1: "Sliding Dash", s2: "Fira", type: "C" },
            { result: "Fire Dash", s1: "Confusion Strike", s2: "Fire", type: "D" },
            { result: "Dark Haze", s1: "Fire Dash", s2: "Zero Gravira", type: "D" },
            { result: "Dark Haze", s1: "Fire Dash", s2: "Blackout", type: "A" },
            { result: "Dark Haze", s1: "Fire Surge", s2: "Zero Gravity", type: "C" },
            { result: "Sonic Blade", s1: "Blitz", s2: "Air Slide", type: "N" },
            { result: "Sonic Blade", s1: "Fire Dash", s2: "Thunder Surge", type: "K" },
            { result: "Sonic Blade", s1: "Blitz", s2: "Dark Haze", type: "D" },
            { result: "Chaos Blade", s1: "Dark Haze", s2: "Sonic Blade", type: "B" },
            { result: "Zantetsuken", s1: "Stopga", s2: "Dark Haze", type: "B" },
            { result: "Zantetsuken", s1: "Stopga", s2: "Sonic Blade", type: "F" },
            { result: "Strike Raid", s1: "Quick Blitz", s2: "Sliding Dash", type: "O" },
            { result: "Freeze Raid", s1: "Strike Raid", s2: "Blizzara", type: "I" },
            { result: "Freeze Raid", s1: "Blizzard Edge", s2: "Binding Strike", type: "K" },
            { result: "Treasure Raid", s1: "Slot Edge", s2: "Strike Raid", type: "O" },
            { result: "Treasure Raid", s1: "Slot Edge", s2: "Magnet", type: "D" },
            { result: "Treasure Raid", s1: "Slot Edge", s2: "Magnera", type: "K" },
            { result: "Spark Raid", s1: "Magnega", s2: "Freeze Raid", type: "J" },
            { result: "Spark Raid", s1: "Magnega", s2: "Treasure Raid", type: "N" },
            { result: "Spark Raid", s1: "Dodge Roll", s2: "Thunder Surge", type: "P", rare: true },
            { result: "Spark Raid", s1: "Dodge Roll", s2: "Thundaga", type: "L", rare: true },
            { result: "Spark Raid", s1: "Dodge Roll", s2: "Stun Block", type: "L", rare: true },
            { result: "Wind Raid", s1: "Aeroga", s2: "Freeze Raid", type: "B" },
            { result: "Wind Raid", s1: "Aeroga", s2: "Treasure Raid", type: "F" },
            { result: "Fire Surge", s1: "Fire Dash", s2: "Ignite", type: "D" },
            { result: "Fire Surge", s1: "Fira", s2: "Fire Strike", type: "A" },
            { result: "Fire Surge", s1: "Fira", s2: "Confusion Strike", type: "O" },
            { result: "Fire Surge", s1: "Fira", s2: "Binding Strike", type: "K" },
            { result: "Barrier Surge", s1: "Barrier", s2: "Fire Dash", type: "D" },
            { result: "Barrier Surge", s1: "Barrier", s2: "Stun Edge", type: "K" },
            { result: "Thunder Surge", s1: "Thundara", s2: "Fire Dash", type: "D" },
            { result: "Thunder Surge", s1: "Thundara", s2: "Freeze Raid", type: "G" },
            { result: "Thunder Surge", s1: "Thundara", s2: "Stun Edge", type: "I" },
            { result: "Thunder Surge", s1: "Thundara", s2: "Confusion Strike", type: "I" },
            { result: "Aerial Slam", s1: "Fire Dash", s2: "High Jump", type: "A" },
            { result: "Aerial Slam", s1: "Fire Surge", s2: "Aero", type: "D" },
            { result: "Aerial Slam", s1: "Fire Strike", s2: "Aerora", type: "C" },
            { result: "Ars Solum", s1: "Dark Haze", s2: "Sonic Blade", type: "B", rare: true },
            { result: "Ars Solum", s1: "Dark Haze", s2: "Stopga", type: "B", rare: true },
            { result: "Ars Solum", s1: "Sonic Blade", s2: "Stopga", type: "K", rare: true },
            { result: "Ars Solum", s1: "Thunder", s2: "Sliding Dash", type: "K", rare: true },
            { result: "Ars Solum", s1: "Thunder", s2: "Strike Raid", type: "L", rare: true },
            { result: "Ars Solum", s1: "Thundara", s2: "Strike Raid", type: "K", rare: true },
            { result: "Ars Solum", s1: "Thundara", s2: "Confusion Strike", type: "I", rare: true },
            { result: "Ars Arcanum", s1: "Blitz", s2: "Aerial Slam", type: "F" },
            { result: "Ars Arcanum", s1: "Quick Blitz", s2: "Slot Edge", type: "O", rare: true },
            { result: "Ars Arcanum", s1: "Quick Blitz", s2: "Blizzard", type: "G", rare: true },
            { result: "Ars Arcanum", s1: "Quick Blitz", s2: "Blizzara", type: "H", rare: true },
            { result: "Ars Arcanum", s1: "Sliding Dash", s2: "Blizzard", type: "E", rare: true },
            { result: "Ars Arcanum", s1: "Sliding Dash", s2: "Blizzara", type: "G", rare: true },
            { result: "Ars Arcanum", s1: "Cura", s2: "Poison Edge", type: "P", rare: true },
            { result: "Ars Arcanum", s1: "Cura", s2: "Blizzard Edge", type: "G", rare: true },
            { result: "Ars Arcanum", s1: "Fire Strike", s2: "Aerora", type: "C", rare: true },
            { result: "Time Splicer", s1: "Aerial Slam", s2: "Stopga", type: "F" },
            { result: "Time Splicer", s1: "Stun Edge", s2: "Slot Edge", type: "K", rare: true },
            { result: "Time Splicer", s1: "Barrier Surge", s2: "Wishing Edge", type: "P", rare: true },
            { result: "Time Splicer", s1: "Stopga", s2: "Barrier", type: "C", rare: true },
            { result: "Poison Edge", s1: "Poison", s2: "Quick Blitz", type: "O" },
            { result: "Poison Edge", s1: "Poison", s2: "Sliding Dash", type: "K" },
            { result: "Poison Edge", s1: "Poison", s2: "Strike Raid", type: "D" },
            { result: "Wishing Edge", s1: "Barrier Surge", s2: "Strike Raid", type: "O" },
            { result: "Wishing Edge", s1: "Barrier Surge", s2: "Stun Edge", type: "K" },
            { result: "Wishing Edge", s1: "Stun Edge", s2: "Binding Strike", type: "J" },
            { result: "Blizzard Edge", s1: "Quick Blitz", s2: "Blizzard", type: "G" },
            { result: "Blizzard Edge", s1: "Quick Blitz", s2: "Blizzara", type: "H" },
            { result: "Blizzard Edge", s1: "Sliding Dash", s2: "Blizzard", type: "E" },
            { result: "Blizzard Edge", s1: "Sliding Dash", s2: "Blizzara", type: "G" },
            { result: "Stun Edge", s1: "Sliding Dash", s2: "Thunder", type: "K" },
            { result: "Stun Edge", s1: "Strike Raid", s2: "Thunder", type: "L" },
            { result: "Stun Edge", s1: "Strike Raid", s2: "Thundara", type: "K" },
            { result: "Slot Edge", s1: "Cura", s2: "Poison Edge", type: "P" },
            { result: "Slot Edge", s1: "Cura", s2: "Blizzard Edge", type: "G" },
            { result: "Slot Edge", s1: "Curaga", s2: "Renewal Block", type: "N" },
            { result: "Slot Edge", s1: "Curaga", s2: "Focus Block", type: "P" },
            { result: "Slot Edge", s1: "Curaga", s2: "Renewal Barrier", type: "N" },
            { result: "Slot Edge", s1: "Curaga", s2: "Focus Barrier", type: "P" },
            { result: "Slot Edge", s1: "Wishing Edge", s2: "Cure", type: "O" },
            { result: "Fire Strike", s1: "Poison Edge", s2: "Fira", type: "D" },
            { result: "Fire Strike", s1: "Stun Edge", s2: "Fire", type: "K" },
            { result: "Fire Strike", s1: "Wishing Edge", s2: "Ignite", type: "A" },
            { result: "Confusion Strike", s1: "Confuse", s2: "Quick Blitz", type: "O" },
            { result: "Confusion Strike", s1: "Confuse", s2: "Strike Raid", type: "G" },
            { result: "Confusion Strike", s1: "Sliding Dash", s2: "Zero Gravity", type: "K" },
            { result: "Binding Strike", s1: "Bind", s2: "Quick Blitz", type: "K" },
            { result: "Binding Strike", s1: "Bind", s2: "Strike Raid", type: "O" },
            { result: "Binding Strike", s1: "Stun Edge", s2: "Zero Gravity", type: "I" },
            { result: "Brutal Blast", s1: "Stun Edge", s2: "Mine Shield", type: "O" },
            { result: "Brutal Blast", s1: "Binding Strike", s2: "Mine Square", type: "L" },
            { result: "Tornado Strike", s1: "Aeroga", s2: "Confusion Strike", type: "G" },
            { result: "Tornado Strike", s1: "Aeroga", s2: "Binding Strike", type: "F" },
            { result: "Magnet Spiral", s1: "Binding Strike", s2: "Collision Magnet", type: "K" },
            { result: "Magnet Spiral", s1: "Binding Strike", s2: "Magnega", type: "J" },
            { result: "Magnet Spiral", s1: "Magnera", s2: "Quick Blitz", type: "K", rare: true },
            { result: "Magnet Spiral", s1: "Magnera", s2: "Stun Edge", type: "L", rare: true },
            { result: "Magnet Spiral", s1: "Zero Gravira", s2: "Magnet", type: "I", rare: true },
            { result: "Windcutter", s1: "Aeroga", s2: "Binding Strike", type: "F" },
            { result: "Windcutter", s1: "Aeroga", s2: "Confusion Strike", type: "G" },
            { result: "Limit Storm", s1: "Brutal Blast", s2: "Confusion Strike", type: "G" },
            { result: "Limit Storm", s1: "Brutal Blast", s2: "Binding Strike", type: "D" },
            { result: "Salvation", s1: "Wind Raid", s2: "Curaga", type: "N" },
            { result: "Collision Magnet", s1: "Magnera", s2: "Quick Blitz", type: "K" },
            { result: "Collision Magnet", s1: "Magnera", s2: "Stun Edge", type: "L" },
            { result: "Collision Magnet", s1: "Zero Gravira", s2: "Magnet", type: "I" },
            { result: "Geo Impact", s1: "Brutal Blast", s2: "Brutal Blast", type: "N" },
            { result: "Sacrifice", s1: "Warp", s2: "Dark Haze", type: "B" },
            { result: "Sacrifice", s1: "Warp", s2: "Poison Edge", type: "D" },
            { result: "Break Time", s1: "Curaga", s2: "Renewal Block", type: "N", rare: true },
            { result: "Break Time", s1: "Curaga", s2: "Focus Block", type: "P", rare: true },
            { result: "Break Time", s1: "Curaga", s2: "Renewal Barrier", type: "N", rare: true },
            { result: "Break Time", s1: "Curaga", s2: "Focus Barrier", type: "P", rare: true },
            { result: "Fira", s1: "Fire", s2: "Fire Dash", type: "D" },
            { result: "Fira", s1: "Fire", s2: "Fire Strike", type: "D" },
            { result: "Fira", s1: "Fire", s2: "Fire", type: "A" },
            { result: "Fira", s1: "Fire", s2: "Ignite", type: "C" },
            { result: "Firaga", s1: "Fira", s2: "Fire Dash", type: "D" },
            { result: "Firaga", s1: "Fira", s2: "Fire", type: "A" },
            { result: "Firaga", s1: "Fira", s2: "Fira", type: "B" },
            { result: "Dark Firaga", s1: "Firaga", s2: "Dark Haze", type: "D" },
            { result: "Dark Firaga", s1: "Firaga", s2: "Blackout", type: "B" },
            { result: "Fission Firaga", s1: "Fira", s2: "Aeroga", type: "A" },
            { result: "Fission Firaga", s1: "Firaga", s2: "Aerora", type: "A" },
            { result: "Fission Firaga", s1: "Firaga", s2: "Aeroga", type: "B" },
            { result: "Triple Firaga", s1: "Firaga", s2: "Blitz", type: "D" },
            { result: "Triple Firaga", s1: "Firaga", s2: "Fira", type: "A" },
            { result: "Triple Firaga", s1: "Firaga", s2: "Firaga", type: "B" },
            { result: "Crawling Fire", s1: "Firaga", s2: "Slow", type: "A" },
            { result: "Crawling Fire", s1: "Firaga", s2: "Stopra", type: "D" },
            { result: "Crawling Fire", s1: "Firaga", s2: "Stopga", type: "B" },
            { result: "Blizzara", s1: "Blizzard", s2: "Strike Raid", type: "G" },
            { result: "Blizzara", s1: "Blizzard", s2: "Blizzard Edge", type: "G" },
            { result: "Blizzara", s1: "Blizzard", s2: "Blizzard", type: "E" },
            { result: "Blizzara", s1: "Blizzard", s2: "Aero", type: "H" },
            { result: "Blizzaga", s1: "Blizzara", s2: "Blizzard Edge", type: "G" },
            { result: "Blizzaga", s1: "Blizzara", s2: "Blizzard", type: "E" },
            { result: "Blizzaga", s1: "Blizzara", s2: "Blizzara", type: "F" },
            { result: "Triple Blizzaga", s1: "Blizzaga", s2: "Blitz", type: "G" },
            { result: "Triple Blizzaga", s1: "Blizzaga", s2: "Blizzara", type: "E" },
            { result: "Triple Blizzaga", s1: "Blizzaga", s2: "Blizzaga", type: "F" },
            { result: "Thundara", s1: "Thunder", s2: "Stun Edge", type: "K" },
            { result: "Thundara", s1: "Thunder", s2: "Thunder", type: "I" },
            { result: "Thundara", s1: "Zero Gravity", s2: "Magnet", type: "L" },
            { result: "Thundaga", s1: "Thundara", s2: "Binding Strike", type: "K" },
            { result: "Thundaga", s1: "Thundara", s2: "Thunder", type: "I" },
            { result: "Thundaga", s1: "Thundara", s2: "Thundara", type: "J" },
            { result: "Thundaga Shot", s1: "Thundaga", s2: "Strike Raid", type: "I" },
            { result: "Thundaga Shot", s1: "Thundaga", s2: "Freeze Raid", type: "E" },
            { result: "Thundaga Shot", s1: "Thundaga", s2: "Firaga", type: "A" },
            { result: "Cura", s1: "Cure", s2: "Thunder", type: "I" },
            { result: "Cura", s1: "Cure", s2: "Cure", type: "M" },
            { result: "Cura", s1: "Cure", s2: "Aero", type: "O" },
            { result: "Curaga", s1: "Cura", s2: "Cure", type: "M" },
            { result: "Curaga", s1: "Cura", s2: "Cura", type: "N" },
            { result: "Mine Shield", s1: "Fira", s2: "Zero Gravity", type: "A" },
            { result: "Mine Shield", s1: "Ignite", s2: "Stop", type: "D" },
            { result: "Mine Shield", s1: "Block", s2: "Fira", type: "C" },
            { result: "Mine Shield", s1: "Block", s2: "Stopra", type: "M" },
            { result: "Mine Square", s1: "Fira", s2: "Stop", type: "A" },
            { result: "Mine Square", s1: "Aerora", s2: "Ignite", type: "D" },
            { result: "Mine Square", s1: "Barrier", s2: "Fira", type: "C" },
            { result: "Mine Square", s1: "Barrier", s2: "Stopra", type: "M" },
            { result: "Seeker Mine", s1: "Mine Shield", s2: "Mine Square", type: "B" },
            { result: "Seeker Mine", s1: "Mine Shield", s2: "Magnega", type: "C" },
            { result: "Seeker Mine", s1: "Mine Square", s2: "Magnega", type: "D" },
            { result: "Zero Gravira", s1: "Zero Gravity", s2: "Thunder", type: "I" },
            { result: "Zero Gravira", s1: "Zero Gravity", s2: "Zero Gravity", type: "M" },
            { result: "Zero Gravira", s1: "Magnet", s2: "Aero", type: "P" },
            { result: "Zero Graviga", s1: "Zero Gravira", s2: "Thundara", type: "I" },
            { result: "Zero Graviga", s1: "Zero Gravira", s2: "Zero Gravity", type: "M" },
            { result: "Zero Graviga", s1: "Zero Gravira", s2: "Zero Gravira", type: "N" },
            { result: "Magnera", s1: "Magnet", s2: "Stun Edge", type: "K" },
            { result: "Magnera", s1: "Magnet", s2: "Thunder", type: "I" },
            { result: "Magnera", s1: "Magnet", s2: "Magnet", type: "M" },
            { result: "Magnega", s1: "Magnera", s2: "Magnet", type: "I" },
            { result: "Magnega", s1: "Magnera", s2: "Magnera", type: "J" },
            { result: "Munny Magnet", s1: "Magnera", s2: "Wishing Edge", type: "K" },
            { result: "Munny Magnet", s1: "Magnera", s2: "Thundara", type: "I" },
            { result: "Energy Magnet", s1: "Magnera", s2: "Cure", type: "M" },
            { result: "Energy Magnet", s1: "Magnera", s2: "Cura", type: "N" },
            { result: "D-Link Magnet", s1: "Magnera", s2: "Zero Gravira", type: "L" },
            { result: "D-Link Magnet", s1: "Magnera", s2: "Stopra", type: "I" },
            { result: "Aerora", s1: "Aero", s2: "Quick Blitz", type: "G" },
            { result: "Aerora", s1: "Aero", s2: "Thunder", type: "I" },
            { result: "Aerora", s1: "Aero", s2: "Aero", type: "E" },
            { result: "Aeroga", s1: "Aerora", s2: "Quick Blitz", type: "O" },
            { result: "Aeroga", s1: "Aerora", s2: "Aero", type: "M" },
            { result: "Aeroga", s1: "Aerora", s2: "Aerora", type: "N" },
            { result: "Warp", s1: "Zero Gravira", s2: "Thundara", type: "I", rare: true },
            { result: "Warp", s1: "Zero Gravira", s2: "Zero Gravity", type: "M", rare: true },
            { result: "Warp", s1: "Zero Gravira", s2: "Zero Gravira", type: "N", rare: true },
            { result: "Warp", s1: "Zero Gravity", s2: "Thunder", type: "I", rare: true },
            { result: "Warp", s1: "Zero Gravity", s2: "Zero Gravity", type: "M", rare: true },
            { result: "Warp", s1: "Magnet", s2: "Aero", type: "P", rare: true },
            { result: "Faith", s1: "Wind Raid", s2: "Break Time", type: "N" },
            { result: "Deep Freeze", s1: "Blizzaga", s2: "Freeze Raid", type: "G" },
            { result: "Deep Freeze", s1: "Blizzaga", s2: "Binding Strike", type: "H" },
            { result: "Deep Freeze", s1: "Blizzaga", s2: "Triple Blizzaga", type: "F" },
            { result: "Glacier", s1: "Deep Freeze", s2: "Blizzaga", type: "E" },
            { result: "Glacier", s1: "Deep Freeze", s2: "Triple Blizzaga", type: "F" },
            { result: "Ice Barrage", s1: "Blizzaga", s2: "Mine Shield", type: "F" },
            { result: "Ice Barrage", s1: "Blizzaga", s2: "Mine Square", type: "H" },
            { result: "Firaga Burst", s1: "Fira", s2: "Aeroga", type: "A", rare: true },
            { result: "Firaga Burst", s1: "Firaga", s2: "Aerora", type: "A", rare: true },
            { result: "Firaga Burst", s1: "Firaga", s2: "Aeroga", type: "B", rare: true },
            { result: "Firaga Burst", s1: "Firaga", s2: "Slow", type: "A", rare: true },
            { result: "Firaga Burst", s1: "Firaga", s2: "Stopra", type: "D", rare: true },
            { result: "Firaga Burst", s1: "Firaga", s2: "Stopga", type: "B", rare: true },
            { result: "Raging Storm", s1: "Fission Firaga", s2: "Firaga Burst", type: "B" },
            { result: "Raging Storm", s1: "Fira", s2: "Fire Dash", type: "D", rare: true },
            { result: "Raging Storm", s1: "Fira", s2: "Fire", type: "A", rare: true },
            { result: "Raging Storm", s1: "Fira", s2: "Fira", type: "B", rare: true },
            { result: "Raging Storm", s1: "Fira", s2: "Firaga", type: "A", rare: true },
            { result: "Raging Storm", s1: "Firaga", s2: "Blitz", type: "D", rare: true },
            { result: "Raging Storm", s1: "Firaga", s2: "Firaga", type: "B", rare: true },
            { result: "Raging Storm", s1: "Fire Surge", s2: "Cartwheel", type: "C", rare: true },
            { result: "Mega Flare", s1: "Fission Firaga", s2: "Crawling Fire", type: "B" },
            { result: "Quake", s1: "Brutal Blast", s2: "Zero Graviga", type: "B" },
            { result: "Quake", s1: "Brutal Blast", s2: "Magnega", type: "C" },
            { result: "Quake", s1: "Brutal Blast", s2: "Brutal Blast", type: "N", rare: true },
            { result: "Quake", s1: "Stun Edge", s2: "Mine Shield", type: "O", rare: true },
            { result: "Quake", s1: "Binding Strike", s2: "Mine Square", type: "L", rare: true },
            { result: "Meteor", s1: "Geo Impact", s2: "Quake", type: "B" },
            { result: "Meteor", s1: "Brutal Blast", s2: "Zero Graviga", type: "B", rare: true },
            { result: "Meteor", s1: "Brutal Blast", s2: "Magnega", type: "C", rare: true },
            { result: "Tornado", s1: "Magnega", s2: "Aeroga", type: "N" },
            { result: "Tornado", s1: "Aerora", s2: "Quick Blitz", type: "O", rare: true },
            { result: "Tornado", s1: "Aerora", s2: "Aero", type: "M", rare: true },
            { result: "Tornado", s1: "Aerora", s2: "Aerora", type: "N", rare: true },
            { result: "Tornado", s1: "Aero", s2: "Quick Blitz", type: "G", rare: true },
            { result: "Tornado", s1: "Aero", s2: "Thunder", type: "I", rare: true },
            { result: "Tornado", s1: "Aero", s2: "Aero", type: "E", rare: true },
            { result: "Transcendence", s1: "Magnet Spiral", s2: "Zero Graviga", type: "J" },
            { result: "Mini", s1: "Magnega", s2: "Magnega", type: "J" },
            { result: "Mini", s1: "Magnega", s2: "Bind", type: "I" },
            { result: "Mini", s1: "Magnera", s2: "Warp", type: "N" },
            { result: "Blackout", s1: "Zero Gravity", s2: "Confuse", type: "M" },
            { result: "Blackout", s1: "Zero Gravira", s2: "Confuse", type: "N" },
            { result: "Blackout", s1: "Zero Gravira", s2: "Poison", type: "P" },
            { result: "Ignite", s1: "Bind", s2: "Fire", type: "A" },
            { result: "Ignite", s1: "Bind", s2: "Fira", type: "C" },
            { result: "Stopra", s1: "Slow", s2: "Slow", type: "L" },
            { result: "Stopra", s1: "Slow", s2: "Stop", type: "K" },
            { result: "Stopra", s1: "Stop", s2: "Stop", type: "I" },
            { result: "Stopga", s1: "Stopra", s2: "Stop", type: "I" },
            { result: "Stopga", s1: "Stopra", s2: "Stopra", type: "J" },
            { result: "Thunder Roll", s1: "Dodge Roll", s2: "Thunder Surge", type: "P" },
            { result: "Thunder Roll", s1: "Dodge Roll", s2: "Thundaga", type: "L" },
            { result: "Thunder Roll", s1: "Dodge Roll", s2: "Stun Block", type: "L" },
            { result: "Firewheel", s1: "Cartwheel", s2: "Fire Surge", type: "B" },
            { result: "Firewheel", s1: "Cartwheel", s2: "Firaga", type: "B" },
            { result: "Firewheel", s1: "Cartwheel", s2: "Fission Firaga", type: "C" },
            { result: "Ice Slide", s1: "Air Slide", s2: "Blizzard Edge", type: "F" },
            { result: "Ice Slide", s1: "Air Slide", s2: "Blizzaga", type: "H" },
            { result: "Fire Glide", s1: "Glide", s2: "Fire Surge", type: "C" },
            { result: "Fire Glide", s1: "Glide", s2: "Firaga", type: "B" },
            { result: "Homing Slide", s1: "Sliding Dash", s2: "Magnera", type: "P" },
            { result: "Homing Slide", s1: "Sliding Dash", s2: "Air Slide", type: "C" },
            { result: "Homing Slide", s1: "Magnet", s2: "Air Slide", type: "L" },
            { result: "Renewal Block", s1: "Block", s2: "Curaga", type: "P" },
            { result: "Renewal Block", s1: "Block", s2: "Esuna", type: "C" },
            { result: "Stun Block", s1: "Block", s2: "Stun Edge", type: "L" },
            { result: "Stun Block", s1: "Block", s2: "Thundaga", type: "I" },
            { result: "Poison Block", s1: "Block", s2: "Poison Edge", type: "H" },
            { result: "Poison Block", s1: "Block", s2: "Poison", type: "P" },
            { result: "Renewal Barrier", s1: "Barrier", s2: "Curaga", type: "P" },
            { result: "Renewal Barrier", s1: "Barrier", s2: "Esuna", type: "N" },
            { result: "Confuse Barrier", s1: "Barrier", s2: "Confusion Strike", type: "C" },
            { result: "Confuse Barrier", s1: "Barrier", s2: "Confuse", type: "L" },
            { result: "Stop Barrier", s1: "Barrier", s2: "Stopga", type: "C" },
            { result: "Payback Fang", s1: "Sliding Dash", s2: "Counter Hammer", type: "P" },
            { result: "Payback Raid", s1: "Sliding Dash", s2: "Strike Raid", type: "P" },
            { result: "Payback Surge", s1: "Sliding Dash", s2: "Fire Surge", type: "C" },
            { result: "Payback Surge", s1: "Sliding Dash", s2: "Thunder Surge", type: "L" },
            { result: "Lightning Ray", s1: "Blitz", s2: "Air Slide", type: "Z", rare: true },
            { result: "Lightning Ray", s1: "Fire Dash", s2: "Thunder Surge", type: "Z", rare: true },
            { result: "Lightning Ray", s1: "Thundara", s2: "Binding Strike", type: "Z", rare: true },
            { result: "Lightning Ray", s1: "Thundara", s2: "Thunder", type: "Z", rare: true },
            { result: "Lightning Ray", s1: "Thundara", s2: "Thundara", type: "Z", rare: true },
            { result: "Lightning Ray", s1: "Blitz", s2: "Dark Haze", type: "Z", rare: true },
            { result: "Lightning Ray", s1: "Blitz", s2: "Aerial Slam", type: "Z", rare: true },
            { result: "Lightning Ray", s1: "Barrier Surge", s2: "Aeroga", type: "Z", rare: true },
            { result: "Meteor Shower", s1: "Blitz", s2: "Zero Graviga", type: "Z", rare: true },
            { result: "Meteor Shower", s1: "Thundaga", s2: "Strike Raid", type: "Z", rare: true },
            { result: "Meteor Shower", s1: "Thundaga", s2: "Freeze Raid", type: "Z", rare: true },
            { result: "Meteor Shower", s1: "Thundaga", s2: "Firaga", type: "Z", rare: true },
            { result: "Bio Barrage", s1: "Poison", s2: "Quick Blitz", type: "Z", rare: true },
            { result: "Bio Barrage", s1: "Poison", s2: "Sliding Dash", type: "Z", rare: true },
            { result: "Bio Barrage", s1: "Poison", s2: "Strike Raid", type: "Z", rare: true },
            { result: "Bio Barrage", s1: "Poison", s2: "Block", type: "Z", rare: true },
            { result: "Bio Barrage", s1: "Poison Edge", s2: "Block", type: "Z", rare: true }
        ];

        const UNIQUE_COMMANDS = Array.from(new Set(RECIPES.flatMap(r => [r.s1, r.s2, r.result]))).sort();

        // --- TYPE ABILITIES MAPPING (KHBBS) ---
        const ABILITY_MATRIX = {
            A: { Shimmering: "Fire Boost", Fleeting: "Magic Haste", Pulsing: "Leaf Bracer", Wellspring: "Air Combo Plus", Soothing: "HP Boost", Hungry: "HP Prize Plus", Abounding: "Link Prize Plus" },
            B: { Shimmering: "Fire Boost", Fleeting: "Reload Boost", Pulsing: "Finish Boost", Wellspring: "Once More", Soothing: "Damage Syphon", Hungry: "HP Prize Plus", Abounding: "EXP Chance" },
            C: { Shimmering: "Fire Screen", Fleeting: "Attack Haste", Pulsing: "Finish Boost", Wellspring: "Combo Plus", Soothing: "HP Boost", Hungry: "HP Prize Plus", Abounding: "Link Prize Plus" },
            D: { Shimmering: "Fire Screen", Fleeting: "Attack Haste", Pulsing: "Leaf Bracer", Wellspring: "Combo Plus", Soothing: "HP Boost", Hungry: "HP Prize Plus", Abounding: "Link Prize Plus" },
            E: { Shimmering: "Blizzard Boost", Fleeting: "Magic Haste", Pulsing: "Leaf Bracer", Wellspring: "Combo Plus", Soothing: "Item Boost", Hungry: "HP Prize Plus", Abounding: "Lucky Strike" },
            F: { Shimmering: "Blizzard Boost", Fleeting: "Reload Boost", Pulsing: "Second Chance", Wellspring: "Air Combo Plus", Soothing: "Damage Syphon", Hungry: "HP Prize Plus", Abounding: "Lucky Strike" },
            G: { Shimmering: "Blizzard Screen", Fleeting: "Attack Haste", Pulsing: "Leaf Bracer", Wellspring: "Air Combo Plus", Soothing: "Item Boost", Hungry: "HP Prize Plus", Abounding: "Lucky Strike" },
            H: { Shimmering: "Blizzard Screen", Fleeting: "Magic Haste", Pulsing: "Combo F Boost", Wellspring: "Air Combo Plus", Soothing: "Item Boost", Hungry: "HP Prize Plus", Abounding: "EXP Walker" },
            I: { Shimmering: "Thunder Boost", Fleeting: "Magic Haste", Pulsing: "Combo F Boost", Wellspring: "Air Combo Plus", Soothing: "HP Boost", Hungry: "Treasure Magnet", Abounding: "Link Prize Plus" },
            J: { Shimmering: "Thunder Boost", Fleeting: "Reload Boost", Pulsing: "Combo F Boost", Wellspring: "Once More", Soothing: "Defender", Hungry: "Treasure Magnet", Abounding: "EXP Chance" },
            K: { Shimmering: "Thunder Screen", Fleeting: "Attack Haste", Pulsing: "Finish Boost", Wellspring: "Combo Plus", Soothing: "HP Boost", Hungry: "Treasure Magnet", Abounding: "Link Prize Plus" },
            L: { Shimmering: "Thunder Screen", Fleeting: "Attack Haste", Pulsing: "Finish Boost", Wellspring: "Combo Plus", Soothing: "HP Boost", Hungry: "Treasure Magnet", Abounding: "Lucky Strike" },
            M: { Shimmering: "Cure Boost", Fleeting: "Magic Haste", Pulsing: "Combo F Boost", Wellspring: "Combo Plus", Soothing: "Item Boost", Hungry: "Treasure Magnet", Abounding: "Lucky Strike" },
            N: { Shimmering: "Cure Boost", Fleeting: "Reload Boost", Pulsing: "Second Chance", Wellspring: "Combo Plus", Soothing: "Defender", Hungry: "Treasure Magnet", Abounding: "Lucky Strike" },
            O: { Shimmering: "Dark Screen", Fleeting: "Attack Haste", Pulsing: "Finish Boost", Wellspring: "Air Combo Plus", Soothing: "Item Boost", Hungry: "Treasure Magnet", Abounding: "Lucky Strike" },
            P: { Shimmering: "Dark Screen", Fleeting: "Magic Haste", Pulsing: "Combo F Boost", Wellspring: "Air Combo Plus", Soothing: "Item Boost", Hungry: "Treasure Magnet", Abounding: "EXP Walker" },
            Z: { Shimmering: "Dark Screen", Fleeting: "Magic Haste", Pulsing: "Combo F Boost", Wellspring: "Air Combo Plus", Soothing: "Item Boost", Hungry: "Treasure Magnet", Abounding: "EXP Walker" }
        };

        // --- CATEGORIES ---
        const ATTACK_CMDS = new Set([
            "Blitz", "Meteor Crash", "Fire Strike", "Magic Hour", "Barrier Surge", "Fire Dash", "Dark Haze", "Confusion Strike",
            "Fire Surge", "Sonic Blade", "Chaos Blade", "Zantetsuken", "Strike Raid", "Freeze Raid", "Treasure Raid",
            "Spark Raid", "Wind Raid", "Ars Solum", "Ars Arcanum", "Time Splicer", "Magnet Spiral", "Tornado Strike",
            "Geo Impact", "Sacrifice", "Break Time", "Slot Edge", "Stun Edge", "Quick Blitz", "Sliding Dash",
            "Poison Edge", "Wishing Edge", "Blizzard Edge", "Binding Strike", "Brutal Blast", "Aerial Slam"
        ]);

        const MAGIC_CMDS = new Set([
            "Aeroga","Aerora","Aero","Bind","Blackout","Blizzaga","Blizzara","Blizzard","Crawling Fire","Cura","Curaga","Cure","Dark Firaga",
            "Deep Freeze","D-Link Magnet","Energy Magnet","Faith","Fire","Fira","Firaga","Firaga Burst","Fission Firaga","Glacier","Ignite","Ice Barrage",
            "Magnera","Magnega","Magnet","Mega Flare","Meteor","Mini","Mine Shield","Mine Square","Munny Magnet","Poison","Quake",
            "Raging Storm","Seeker Mine","Slow","Stop","Stopga","Stopra","Thundaga","Thundaga Shot","Thundara","Thunder","Tornado","Transcendence",
            "Triple Blizzaga","Triple Firaga","Warp","Zero Gravity","Zero Gravira","Zero Graviga"
        ]);

        const ACTION_CMDS = new Set([
            "Thunder Roll", "Firewheel", "Ice Slide", "Fire Glide", "Homing Slide",
            "Renewal Block", "Stun Block", "Poison Block", "Payback Fang", "Renewal Barrier", "Confuse Barrier", "Stop Barrier", "Payback Raid", "Payback Surge",
            "Dodge Roll", "Cartwheel", "Air Slide", "Glide", "Block", "Counter Hammer", "High Jump", "Jump"
        ]);

        const SHOTLOCK_CMDS = new Set([
            "Bio Barrage", "Lightning Ray", "Meteor Shower"
        ]);

        // --- ELEMENTS ---
        const targetInput = document.getElementById('targetInput');
        const suggestions = document.getElementById('suggestions');
        const treeContainer = document.getElementById('treeContainer');

        // --- HELPERS ---
        function getCommandInfo(name) {
            const cmd = UNIQUE_COMMANDS.find(c => c.toLowerCase() === name.toLowerCase()) || name;
            if (ATTACK_CMDS.has(cmd)) return { icon: 'swords', color: 'text-orange-400', bg: 'bg-orange-soft' };
            if (MAGIC_CMDS.has(cmd)) return { icon: 'wand-sparkles', color: 'text-purple-400', bg: 'bg-purple-soft' };
            if (ACTION_CMDS.has(cmd)) return { icon: 'shield', color: 'text-yellow-400', bg: 'bg-yellow-soft' };
            if (SHOTLOCK_CMDS.has(cmd)) return { icon: 'crosshair', color: 'text-green-400', bg: 'bg-green-soft' };
            return { icon: 'circle-dashed', color: 'text-slate-500', bg: 'bg-slate-800' };
        }

        // --- RECURSIVE RENDERER ---

        const MAX_DEPTH = 2; // Maximum recursion depth to prevent stack overflow

        function renderNode(commandName, depth = 0) {
            const recipes = RECIPES.filter(r => r.result.toLowerCase() === commandName.toLowerCase());
            const info = getCommandInfo(commandName);

            // Leaf Node Condition:
            // 1. No recipes exist for this command
            // 2. OR Max depth reached (we stop expanding here)
            if (recipes.length === 0 || depth >= MAX_DEPTH) {
                return `
                    <div class="base-ingredient">
                        <i data-lucide="${info.icon}" class="${info.color}" style="width: 16px; height: 16px;"></i>
                        <span>${commandName}</span>
                        ${recipes.length > 0 ? `<span class="text-xs text-slate-500 ml-auto border border-slate-700 px-1 rounded">Has Recipes</span>` : ''}
                    </div>
                `;
            }

            // Helper to generate tooltip HTML
            function getTooltipHtml(type) {
                const abilities = Object.entries(ABILITY_MATRIX[type]).map(([key, value]) => {
                    return {
                        category: key,    // This replaces "entry.c"
                        details: value    // This contains all the sub-items (Shimmering, etc.)
                    };
                });
                if (abilities.length === 0) return '';

                let rows = abilities.map(entry => `
                    <tr>
                        <td>${entry.category}</td>
                        <td>${entry.details}</td> 
                    </tr>
                `).join('');

                return `
                    <div class="tooltip-content">
                        <span class="tooltip-title">Type ${type} Synthesis</span>
                        <table class="tooltip-table">
                            ${rows}
                        </table>
                    </div>
                `;
            }

            // Root Node (Depth 0) - The Main Card
            if (depth === 0) {
                let html = `
                    <div class="node-header">
                        <div class="node-icon ${info.bg}">
                            <i data-lucide="${info.icon}" class="${info.color}" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div>
                            <h2 class="node-title">${commandName}</h2>
                            <p class="node-subtitle">${recipes.length > 0 ? `${recipes.length} Recipe${recipes.length !== 1 ? 's' : ''} Available` : 'Base Command / Purchase Only'}</p>
                        </div>
                    </div>
                `;

                html += `<div class="recipe-list">`;
                recipes.forEach(recipe => {
                    html += `
                        <div class="recipe-card">
                            <div class="recipe-header">
                                <span>
                                    <div class="type-badge-container">
                                        <span class="type-badge">Type ${recipe.type}</span>
                                        ${getTooltipHtml(recipe.type)}
                                    </div>
                                    ${recipe.rare ? '<span class="rare-badge">Rare</span>' : ''}
                                </span>
                                <span class="text-xs text-slate-400">Recipe: ${recipe.s1} + ${recipe.s2}</span>
                            </div>
                            <div class="recipe-ingredients">
                                ${renderNode(recipe.s1, depth + 1)}
                                ${renderNode(recipe.s2, depth + 1)}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
                return html;
            }

            // Intermediate Node (Depth 1...MAX_DEPTH-1) - Expandable Details
            const isOpen = '';

            let html = `
                <details class="ingredient-node" ${isOpen}>
                    <summary>
                        <span class="flex items-center gap-2">
                            <i data-lucide="${info.icon}" class="${info.color}" style="width: 16px; height: 16px;"></i>
                            <span class="font-semibold text-sm text-slate-200">${commandName}</span>
                        </span>
                        <span class="text-xs text-slate-500">${recipes.length} ways</span>
                    </summary>
                    <div class="ingredient-children">
                        <div class="flex flex-col gap-2">
            `;

            recipes.forEach(recipe => {
                html += `
                    <div class="recipe-card">
                        <div class="recipe-header">
                            <span>
                                <div class="type-badge-container">
                                    <span class="type-badge">Type ${recipe.type}</span>
                                    ${getTooltipHtml(recipe.type)}
                                </div>
                                ${recipe.rare ? '<span class="rare-badge">Rare</span>' : ''}
                            </span>
                        </div>
                        <div class="recipe-ingredients">
                            ${renderNode(recipe.s1, depth + 1)}
                            ${renderNode(recipe.s2, depth + 1)}
                        </div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>
                </details>
            `;
            return html;
        }


        // --- AUTOCOMPLETE & EVENTS ---

        targetInput.addEventListener('input', () => {
            const val = targetInput.value.toLowerCase();
            suggestions.innerHTML = '';

            if (!val) {
                suggestions.classList.add('hidden');
                return;
            }

            const matches = UNIQUE_COMMANDS.filter(c => c.toLowerCase().includes(val));

            if (matches.length > 0) {
                suggestions.classList.remove('hidden');
                matches.forEach(match => {
                    const btn = document.createElement('button');
                    btn.className = "suggestion-item";
                    btn.textContent = match;
                    btn.addEventListener('click', () => {
                        targetInput.value = match;
                        suggestions.classList.add('hidden');
                        generateTree(match);
                    });
                    suggestions.appendChild(btn);
                });
            } else {
                suggestions.classList.add('hidden');
            }
        });

        // Close suggestions on click outside
        document.addEventListener('click', (e) => {
            if (!targetInput.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.classList.add('hidden');
            }
            // Close floating details if clicking outside (optional UX improvement)
            if (!e.target.closest('details.ingredient-node')) {
                document.querySelectorAll('details.ingredient-node[open]').forEach(el => {
                    el.removeAttribute('open');
                });
            }
        });

        function generateTree(commandName) {
            // Find official casing
            const officialName = UNIQUE_COMMANDS.find(c => c.toLowerCase() === commandName.toLowerCase()) || commandName;

            const treeHTML = renderNode(officialName, 0);
            treeContainer.innerHTML = treeHTML;

            lucide.createIcons();
        }

        // Handle Enter key
        targetInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                generateTree(targetInput.value);
                suggestions.classList.add('hidden');
            }
        });

        // Initial Icon Load
        lucide.createIcons();

    </script>
</body>

</html>